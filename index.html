<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BTV Opleidingen - OC & Taal Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp, collection, addDoc, query, where, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBRq1HFmhrpW_EMMZwpURrbTArz-L5iWT4",
            authDomain: "pvaangifteinleveren-77dbe.firebaseapp.com",
            projectId: "pvaangifteinleveren-77dbe",
            storageBucket: "pvaangifteinleveren-77dbe.firebasestorage.app",
            messagingSenderId: "20239054410",
            appId: "1:20239054410:web:264b3c759312248d9f18b3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- LIVE DAA (Samenwerken) ---
        window.updateDAA = async () => {
            const klas = document.getElementById('klas').value;
            const tekst = document.getElementById('daaLive').value;
            if(!klas) return alert("Kies eerst een klas om samen te werken aan de DAA.");
            await setDoc(doc(db, "live_daa", klas), { tekst, timestamp: serverTimestamp() });
        };

        // Luister naar DAA wijzigingen van klasgenoten
        let unsubscribeDAA = null;
        window.setupDAAListener = (klas) => {
            if (unsubscribeDAA) unsubscribeDAA();
            const daaInput = document.getElementById('daaLive');
            unsubscribeDAA = onSnapshot(doc(db, "live_daa", klas), (snap) => {
                if(snap.exists() && document.activeElement !== daaInput) {
                    daaInput.value = snap.data().tekst;
                }
            });
        };

        // --- FEED & FEEDBACK ---
        window.laadKlas = (gekozenKlas) => {
            window.setupDAAListener(gekozenKlas);
            document.querySelectorAll('.klas-btn').forEach(btn => btn.classList.replace('bg-yellow-400', 'police-blue'));
            const activeBtn = document.getElementById(`btn-${gekozenKlas}`);
            if(activeBtn) activeBtn.classList.replace('police-blue', 'bg-yellow-400');

            document.getElementById('currentKlas').innerText = gekozenKlas;
            const q = query(collection(db, "casus_inzendingen"), where("klas", "==", gekozenKlas), orderBy("timestamp", "desc"));
            
            onSnapshot(q, (snapshot) => {
                const lijst = document.getElementById('feedbackLijst');
                let html = "";
                snapshot.forEach(docSnap => {
                    const d = docSnap.data();
                    const id = docSnap.id;
                    const criteria = ["Doel Helder", "Aanpak Logisch", "Analyse Diep", "Actieve Vorm", "Ik-vorm"];
                    let fbHtml = "";
                    criteria.forEach((label, i) => {
                        const fieldName = `fb_${i}`;
                        fbHtml += `<label class="flex items-center space-x-1 bg-gray-50 p-1 rounded border text-[9px] uppercase font-bold cursor-pointer"><input type="checkbox" ${d[fieldName] ? "checked" : ""} onchange="window.updateFeedback('${id}', '${fieldName}', this.checked)"> <span>${label}</span></label>`;
                    });
                    html += `<div class="bg-white border-2 border-blue-900 p-4 mb-4 shadow rounded-lg animate-fade-in"><div class="flex justify-between border-b pb-1 mb-2 text-[10px] font-black text-blue-900 uppercase"><span>VBL: ${d.student}</span><span>${d.timestamp?.toDate().toLocaleTimeString() || '...'}</span></div><div class="text-sm italic mb-3 whitespace-pre-wrap">${d.pv}</div><div class="grid grid-cols-2 md:grid-cols-5 gap-1">${fbHtml}</div></div>`;
                });
                lijst.innerHTML = html || "<p class='text-center text-gray-400 text-xs py-4'>Nog geen inzendingen in deze klas.</p>";
            });
        };

        window.updateFeedback = async (id, field, val) => { await updateDoc(doc(db, "casus_inzendingen", id), { [field]: val }); };

        window.submitCasus = async () => {
            const naam = document.getElementById('naam').value;
            const klas = document.getElementById('klas').value;
            const pv = document.getElementById('pvText').value;
            if(!naam || !klas || !pv) return alert("Vul alle velden in!");
            await addDoc(collection(db, "casus_inzendingen"), { student: naam, klas, pv, timestamp: serverTimestamp() });
            document.getElementById('pvText').value = "";
            alert("PV verzonden naar de docent!");
        };

        window.onload = () => {
            ['Delta', 'Echo', 'Foxtrot', 'Mike', 'Lima'].forEach(k => {
                onSnapshot(query(collection(db, "casus_inzendingen"), where("klas", "==", k)), (snap) => {
                    const el = document.getElementById(`count-${k}`);
                    if(el) el.innerText = snap.size;
                });
            });
        };
    </script>

    <style>
        .police-blue { background-color: #002d5e; }
        .emergency-red { background-color: #990000; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    </style>
</head>
<body class="bg-slate-200 p-2 md:p-6 font-sans">
    <div class="max-w-5xl mx-auto space-y-4">
        
        <header class="police-blue text-white p-4 rounded shadow-lg flex justify-between items-center border-b-4 border-yellow-500">
            <div>
                <h1 class="text-xl font-black italic text-yellow-400 uppercase tracking-tighter">UNIT: DAA & TAAL TRAINING</h1>
                <p class="text-[9px] uppercase tracking-widest font-bold opacity-70 italic">Focus: Actief schrijven & Doel-Aanpak-Analyse</p>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white p-4 border-l-4 border-blue-900 shadow rounded">
                <h3 class="text-[10px] font-black uppercase text-blue-900 mb-2">üìã Werkwijze</h3>
                <ul class="text-[11px] text-slate-600 space-y-1 italic">
                    <li>1. Bekijk de OC-melding en de foto's.</li>
                    <li>2. Vul samen met een collega de DAA in.</li>
                    <li>3. Vertaal de passieve zin naar een actieve ik-vorm.</li>
                    <li>4. Lever je PV individueel in.</li>
                </ul>
            </div>

            <div class="md:col-span-2 emergency-red text-white p-4 shadow rounded">
                <div class="flex gap-4">
                    <div class="flex-1">
                        <h3 class="text-[10px] font-black uppercase mb-1 tracking-widest text-yellow-400">üö® OC-MELDING: VERKEER</h3>
                        <p class="text-xs font-mono bg-black/20 p-2 rounded">"Ter hoogte van het kruispunt ligt een motorrijder op het wegdek. Er is een verkeersbord uit de grond gereden. Ambulance is onderweg."</p>
                    </div>
                    <div class="hidden md:grid grid-cols-2 gap-1 w-40">
                        <img src="https://images.unsplash.com/photo-1558981403-c5f9899a28bc?auto=format&fit=crop&w=150" class="rounded border border-white/20 object-cover h-16 w-full">
                        <img src="https://images.unsplash.com/photo-1502740479091-6358875c8284?auto=format&fit=crop&w=150" class="rounded border border-white/20 object-cover h-16 w-full">
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-blue-900 text-white p-4 rounded shadow-lg">
            <h3 class="text-[10px] font-black uppercase mb-2 text-yellow-400">‚úçÔ∏è Taaloefening: Maak ACTIEF (Verleden tijd + Ik-vorm)</h3>
            <div class="bg-white/10 p-3 rounded border border-white/20 italic text-sm">
                "Door mij werd de motorrijder in stabiele zijligging gelegd en het verkeersbord werd door mij veiliggesteld."
            </div>
            <p class="text-[9px] mt-2 opacity-70 uppercase font-bold tracking-widest">Verwerk de verbeterde zin in je PV hieronder.</p>
        </div>

        <section class="bg-yellow-50 border-2 border-yellow-400 p-4 shadow rounded">
            <h3 class="text-[10px] font-black uppercase text-yellow-800 mb-2 flex justify-between">
                <span>üß† SAMENWERKEN: DOEL - AANPAK - ANALYSE (DAA)</span>
                <span class="animate-pulse bg-yellow-200 px-2 rounded text-[8px]">LIVE SYNC</span>
            </h3>
            <textarea id="daaLive" oninput="window.updateDAA()" placeholder="Overleg hier met je collega over het Doel, de Aanpak en de uiteindelijke Analyse van dit incident..." class="w-full border-none p-3 h-28 rounded font-serif text-sm bg-white outline-none shadow-inner"></textarea>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="bg-white p-4 shadow border-t-4 border-yellow-500 rounded">
                <input type="text" id="naam" placeholder="Naam/Roepnummer" class="w-full border p-2 mb-2 text-sm rounded outline-none bg-slate-50">
                <select id="klas" onchange="window.laadKlas(this.value)" class="w-full border p-2 mb-2 text-sm font-bold rounded outline-none bg-slate-50 uppercase">
                    <option value="">Kies je klas...</option>
                    <option>Delta</option><option>Echo</option><option>Foxtrot</option><option>Mike</option><option>Lima</option>
                </select>
                <textarea id="pvText" placeholder="Schrijf hier je PV (Vergeet de actieve ik-vorm niet)..." class="w-full border p-2 h-64 mb-2 text-sm rounded outline-none bg-slate-50"></textarea>
                <button onclick="submitCasus()" class="w-full police-blue text-white font-black py-4 uppercase text-xs rounded shadow-lg active:scale-95 transition-all">Definitief Inleveren</button>
            </div>

            <div class="lg:col-span-2 bg-white p-4 shadow rounded border-t-4 border-blue-900">
                <div class="flex flex-wrap gap-2 mb-4 border-b pb-3">
                    <button onclick="laadKlas('Delta')" id="btn-Delta" class="klas-btn police-blue text-white px-3 py-2 rounded text-[10px] font-black uppercase flex items-center gap-2">Delta <span id="count-Delta" class="bg-white text-blue-900 px-1.5 rounded-full">0</span></button>
                    <button onclick="laadKlas('Echo')" id="btn-Echo" class="klas-btn police-blue text-white px-3 py-2 rounded text-[10px] font-black uppercase flex items-center gap-2">Echo <span id="count-Echo" class="bg-white text-blue-900 px-1.5 rounded-full">0</span></button>
                    <button onclick="laadKlas('Foxtrot')" id="btn-Foxtrot" class="klas-btn police-blue text-white px-3 py-2 rounded text-[10px] font-black uppercase flex items-center gap-2">Foxtrot <span id="count-Foxtrot" class="bg-white text-blue-900 px-1.5 rounded-full">0</span></button>
                    <button onclick="laadKlas('Mike')" id="btn-Mike" class="klas-btn police-blue text-white px-3 py-2 rounded text-[10px] font-black uppercase flex items-center gap-2">Mike <span id="count-Mike" class="bg-white text-blue-900 px-1.5 rounded-full">0</span></button>
                    <button onclick="laadKlas('Lima')" id="btn-Lima" class="klas-btn police-blue text-white px-3 py-2 rounded text-[10px] font-black uppercase flex items-center gap-2">Lima <span id="count-Lima" class="bg-white text-blue-900 px-1.5 rounded-full">0</span></button>
                </div>
                <h3 class="text-[10px] font-black uppercase text-blue-900 mb-2 italic">Feed Eenheid: <span id="currentKlas" class="text-red-700 font-bold">-</span></h3>
                <div id="feedbackLijst" class="space-y-4 max-h-[800px] overflow-y-auto pr-2"></div>
            </div>
        </div>
    </div>
</body>
</html>
