<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BTV - OC Master Dashboard 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp, collection, addDoc, query, where, orderBy, updateDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBRq1HFmhrpW_EMMZwpURrbTArz-L5iWT4",
            authDomain: "pvaangifteinleveren-77dbe.firebaseapp.com",
            projectId: "pvaangifteinleveren-77dbe",
            storageBucket: "pvaangifteinleveren-77dbe.firebasestorage.app",
            messagingSenderId: "20239054410",
            appId: "1:20239054410:web:264b3c759312248d9f18b3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- 1. DUAL WHITEBOARDS ---
        function setupWhiteboard(canvasId, docName) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            let drawing = false;

            canvas.width = canvas.offsetWidth;
            canvas.height = 200;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.strokeStyle = docName === 'redenen' ? '#b91c1c' : '#1e3a8a';

            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };

            canvas.onmousedown = (e) => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); };
            canvas.onmousemove = (e) => { if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
            const stop = async () => { if(!drawing) return; drawing = false; await setDoc(doc(db, "whiteboards", docName), { image: canvas.toDataURL('image/webp', 0.5) }); };
            window.addEventListener('mouseup', stop);
            
            // Touch support
            canvas.addEventListener('touchstart', (e) => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); e.preventDefault(); }, {passive: false});
            canvas.addEventListener('touchmove', (e) => { if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); }, {passive: false});
            canvas.addEventListener('touchend', stop);

            onSnapshot(doc(db, "whiteboards", docName), (snap) => {
                if (snap.exists() && !drawing) {
                    const img = new Image();
                    img.onload = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0); };
                    img.src = snap.data().image;
                }
            });
        }

        // --- 2. DAA & KLAS LOGICA ---
        let daaUnsub = null;
        window.laadKlas = (gekozenKlas) => {
            document.querySelectorAll('.klas-btn').forEach(btn => btn.classList.replace('bg-yellow-400', 'police-blue'));
            document.getElementById(`btn-${gekozenKlas}`).classList.replace('police-blue', 'bg-yellow-400');
            document.getElementById('currentKlas').innerText = gekozenKlas;

            // Live DAA per klas
            if (daaUnsub) daaUnsub();
            const daaField = document.getElementById('daaLive');
            daaUnsub = onSnapshot(doc(db, "live_daa", gekozenKlas), (snap) => {
                if(snap.exists() && document.activeElement !== daaField) daaField.value = snap.data().tekst;
                else if (!snap.exists()) daaField.value = "";
            });

            // Live Feed PV's
            const q = query(collection(db, "casus_inzendingen"), where("klas", "==", gekozenKlas), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                const lijst = document.getElementById('feedbackLijst');
                let html = "";
                snapshot.forEach(docSnap => {
                    const d = docSnap.data();
                    const criteria = ["Doel", "Aanpak", "Analyse", "Actief", "Ik-vorm"];
                    let fbHtml = "";
                    criteria.forEach((label, i) => {
                        const field = `fb_${i}`;
                        fbHtml += `<label class="flex items-center space-x-1 bg-gray-100 p-1 rounded text-[9px] font-bold"><input type="checkbox" ${d[field] ? "checked" : ""} onchange="window.updateFb('${docSnap.id}', '${field}', this.checked)"><span>${label}</span></label>`;
                    });
                    html += `<div class="bg-white border-2 border-blue-900 p-4 mb-4 rounded shadow-lg animate-fade-in"><div class="flex justify-between text-[10px] font-black border-b mb-2"><span>${d.student}</span><span>${d.timestamp?.toDate().toLocaleTimeString() || '...'}</span></div><div class="text-sm mb-3 italic">${d.pv}</div><div class="grid grid-cols-2 md:grid-cols-5 gap-1">${fbHtml}</div></div>`;
                });
                lijst.innerHTML = html || "<p class='text-center text-gray-400 py-4'>Nog geen inzendingen.</p>";
            });
        };

        window.updateDAA = async () => {
            const klas = document.getElementById('klas').value;
            if(!klas) return;
            await setDoc(doc(db, "live_daa", klas), { tekst: document.getElementById('daaLive').value });
        };

        window.updateFb = async (id, field, val) => { await updateDoc(doc(db, "casus_inzendingen", id), { [field]: val }); };

        window.submitCasus = async () => {
            const naam = document.getElementById('naam').value;
            const klas = document.getElementById('klas').value;
            const pv = document.getElementById('pvText').value;
            if(!naam || !klas || !pv) return alert("Alles invullen!");
            await addDoc(collection(db, "casus_inzendingen"), { student: naam, klas, pv, timestamp: serverTimestamp() });
            document.getElementById('pvText').value = "";
            alert("PV Ingediend!");
        };

        window.fullReset = async () => {
            if(!confirm("âš ï¸ LET OP: Dit wist alle borden, DAA's en PV's van alle klassen!")) return;
            const batch = writeBatch(db);
            // Wis Borden
            batch.set(doc(db, "whiteboards", "redenen"), { image: "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" });
            batch.set(doc(db, "whiteboards", "filmisch"), { image: "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" });
            // Wis PV's
            const pvs = await getDocs(collection(db, "casus_inzendingen"));
            pvs.forEach(d => batch.delete(d.ref));
            // Wis DAA's
            const daas = await getDocs(collection(db, "live_daa"));
            daas.forEach(d => batch.delete(d.ref));
            await batch.commit();
            location.reload();
        };

        window.onload = () => {
            setupWhiteboard('canvasRedenen', 'redenen');
            setupWhiteboard('canvasFilmisch', 'filmisch');
            ['Delta', 'Echo', 'Foxtrot', 'Mike', 'Lima'].forEach(k => {
                onSnapshot(query(collection(db, "casus_inzendingen"), where("klas", "==", k)), (snap) => {
                    document.getElementById(`count-${k}`).innerText = snap.size;
                });
            });
        };
    </script>

    <style>
        .police-blue { background-color: #002d5e; }
        .emergency-red { background-color: #990000; }
        canvas { touch-action: none; cursor: crosshair; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-200 p-2 md:p-4 font-sans text-slate-900">
    <div class="max-w-6xl mx-auto space-y-4">
        
        <header class="police-blue text-white p-4 rounded shadow-lg flex justify-between items-center border-b-4 border-yellow-500">
            <div>
                <h1 class="text-xl font-black italic text-yellow-400 uppercase tracking-tighter">BTV TRAINING: OC INTERACTIEF</h1>
                <p class="text-[9px] uppercase font-bold opacity-60">Doel - Aanpak - Analyse & PV Vaardigheden</p>
            </div>
            <button onclick="fullReset()" class="bg-red-600 hover:bg-red-800 text-white px-3 py-1 rounded text-[10px] font-black uppercase transition">Systeem Reset</button>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white p-4 border-l-4 border-blue-900 shadow rounded">
                <h3 class="text-[10px] font-black uppercase text-blue-900 mb-2">ðŸ“‹ Instructie</h3>
                <p class="text-[11px] italic leading-snug">1. Analyseer de melding. 2. Werk samen de DAA uit in het gele vak. 3. Vertaal de passieve zin uit de OC-melding naar een actieve ik-vorm in je PV.</p>
            </div>
            <div class="md:col-span-2 emergency-red text-white p-4 shadow rounded flex gap-4">
                <div class="flex-1">
                    <h3 class="text-[10px] font-black uppercase mb-1 tracking-widest text-yellow-300">ðŸš¨ OC-MELDING: VERKEER</h3>
                    <p class="text-xs font-mono bg-black/20 p-2 rounded italic">"Kruispunt: Motorrijder onderuit. Verkeersbord werd door mij (VBL) veiliggesteld. Maak deze zin actief in je PV."</p>
                </div>
                <div class="hidden md:flex gap-2 w-48">
                    <img src="https://images.unsplash.com/photo-1558981403-c5f9899a28bc?auto=format&fit=crop&w=150" class="rounded h-16 w-1/2 object-cover border border-white/20">
                    <img src="https://images.unsplash.com/photo-1502740479091-6358875c8284?auto=format&fit=crop&w=150" class="rounded h-16 w-1/2 object-cover border border-white/20">
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white p-2 border-2 border-blue-900 shadow relative rounded">
                <h3 class="text-[9px] font-black text-blue-900 uppercase mb-1">Bord 1: Waarnemingen</h3>
                <canvas id="canvasRedenen" class="w-full bg-slate-50 rounded shadow-inner"></canvas>
            </div>
            <div class="bg-white p-2 border-2 border-blue-900 shadow relative rounded">
                <h3 class="text-[9px] font-black text-blue-900 uppercase mb-1">Bord 2: Filmische Zinnen</h3>
                <canvas id="canvasFilmisch" class="w-full bg-slate-50 rounded shadow-inner"></canvas>
            </div>
        </div>

        <section class="bg-yellow-50 border-2 border-yellow-400 p-4 shadow rounded">
            <h3 class="text-[10px] font-black text-yellow-800 uppercase mb-2 flex justify-between">
                <span>ðŸ§  LIVE DAA: DOEL - AANPAK - ANALYSE (Selecteer klas)</span>
                <span class="animate-pulse bg-yellow-200 px-2 rounded text-[8px]">SYNC ACTIEF</span>
            </h3>
            <textarea id="daaLive" oninput="window.updateDAA()" placeholder="Kies eerst een klas. Werk hier samen aan de DAA..." class="w-full p-3 h-24 rounded font-serif text-sm bg-white outline-none shadow-inner"></textarea>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="bg-white p-4 shadow border-t-4 border-yellow-500 rounded">
                <input type="text" id="naam" placeholder="Naam Student" class="w-full border p-2 mb-2 text-sm rounded bg-slate-50">
                <select id="klas" onchange="window.laadKlas(this.value)" class="w-full border p-2 mb-2 text-sm font-bold rounded bg-slate-50">
                    <option value="">Kies klas...</option><option>Delta</option><option>Echo</option><option>Foxtrot</option><option>Mike</option><option>Lima</option>
                </select>
                <textarea id="pvText" placeholder="Schrijf je PV (Actieve ik-vorm)..." class="w-full border p-2 h-64 mb-2 text-sm rounded bg-slate-50"></textarea>
                <button onclick="submitCasus()" class="w-full police-blue text-white font-black py-4 uppercase text-xs rounded shadow-lg active:scale-95">Inleveren</button>
            </div>

            <div class="lg:col-span-2 bg-white p-4 shadow border-t-4 border-blue-900 rounded">
                <div class="flex flex-wrap gap-1 mb-4 border-b pb-3">
                    <button onclick="laadKlas('Delta')" id="btn-Delta" class="klas-btn police-blue text-white px-3 py-2 rounded text-[9px] font-black uppercase flex items-center gap-1">Delta <span id="count-Delta" class="bg-white text-blue-900 px-1 rounded-full">0</span></button>
                    <button onclick="laadKlas('Echo')" id="btn-Echo" class="klas-btn police-blue text-white px-3 py-2 rounded text-[9px] font-black uppercase flex items-center gap-1">Echo <span id="count-Echo" class="bg-white text-blue-900 px-1 rounded-full">0</span></button>
                    <button onclick="laadKlas('Foxtrot')" id="btn-Foxtrot" class="klas-btn police-blue text-white px-3 py-2 rounded text-[9px] font-black uppercase flex items-center gap-1">Foxtrot <span id="count-Foxtrot" class="bg-white text-blue-900 px-1 rounded-full">0</span></button>
                    <button onclick="laadKlas('Mike')" id="btn-Mike" class="klas-btn police-blue text-white px-3 py-2 rounded text-[9px] font-black uppercase flex items-center gap-1">Mike <span id="count-Mike" class="bg-white text-blue-900 px-1 rounded-full">0</span></button>
                    <button onclick="laadKlas('Lima')" id="btn-Lima" class="klas-btn police-blue text-white px-3 py-2 rounded text-[9px] font-black uppercase flex items-center gap-1">Lima <span id="count-Lima" class="bg-white text-blue-900 px-1 rounded-full">0</span></button>
                </div>
                <h3 class="text-[10px] font-black uppercase text-blue-900 mb-2 italic">Feed: <span id="currentKlas" class="text-red-700">-</span></h3>
                <div id="feedbackLijst" class="space-y-4 max-h-[800px] overflow-y-auto pr-1"></div>
            </div>
        </div>
    </div>
</body>
</html>
