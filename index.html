<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q2les1PVBevindingen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBRq1HFmhrpW_EMMZwpURrbTArz-L5iWT4",
            authDomain: "pvaangifteinleveren-77dbe.firebaseapp.com",
            databaseURL: "https://pvaangifteinleveren-77dbe-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pvaangifteinleveren-77dbe",
            storageBucket: "pvaangifteinleveren-77dbe.firebasestorage.app",
            messagingSenderId: "20239054410",
            appId: "1:20239054410:web:264b3c759312248d9f18b3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.onload = () => {
            alert("VEILIGHEIDSMELDING: U betreedt een beveiligde werkomgeving. Ga vertrouwelijk om met de gegevens van medestudenten en de casuïstiek.");
        };

        async function wijsPartnerToe() {
            const klas = document.getElementById('klas').value;
            const eigenNaam = document.getElementById('naam').value;
            const partnerDisplay = document.getElementById('partnerDisplay');

            if(!eigenNaam) return alert("Voer eerst uw eigen voornaam in.");
            partnerDisplay.innerText = "Zoeken...";

            const q = query(collection(db, "casus_inzendingen"), where("klas", "==", klas));
            const snap = await getDocs(q);
            let studenten = [];
            snap.forEach(doc => {
                if(doc.data().student !== eigenNaam) studenten.push(doc.data().student);
            });

            if(studenten.length > 0) {
                const partner = studenten[Math.floor(Math.random() * studenten.length)];
                partnerDisplay.innerText = partner;
                document.getElementById('hiddenPartner').value = partner;
            } else {
                partnerDisplay.innerText = "Geen klasgenoten online";
            }
        }

        async function submitCasus() {
            const naam = document.getElementById('naam').value;
            const klas = document.getElementById('klas').value;
            const partner = document.getElementById('hiddenPartner').value;
            const daa = document.getElementById('daaText').value;
            const pv = document.getElementById('pvText').value;

            if(!naam || !daa || !pv) return alert("FOUT: Alle velden zijn verplicht.");
            
            if(confirm("Bevestig: U staat op het punt uw DAA en PV definitief in te leveren.")) {
                try {
                    await addDoc(collection(db, "casus_inzendingen"), {
                        student: naam, partner, klas, daa, pv, timestamp: serverTimestamp()
                    });
                    alert("Systeemmelding: Inzending succesvol opgeslagen.");
                    location.reload();
                } catch (e) { console.error(e); }
            }
        }

        async function updateFeedback(docId, criteriaIndex, isChecked) {
            try {
                const docRef = doc(db, "casus_inzendingen", docId);
                await updateDoc(docRef, { [`feedback_${criteriaIndex}`]: isChecked });
            } catch (e) { console.error(e); }
        }

        async function laadKlas(gekozenKlas) {
            const lijst = document.getElementById('feedbackLijst');
            lijst.innerHTML = "<p class='text-center p-4 italic'>Inzendingen worden geladen...</p>";
            
            const q = query(collection(db, "casus_inzendingen"), where("klas", "==", gekozenKlas));
            const snap = await getDocs(q);
            lijst.innerHTML = "";

            if(snap.empty) {
                lijst.innerHTML = "<p class='text-center p-4 text-gray-500'>Geen inzendingen gevonden voor klas " + gekozenKlas + ".</p>";
                return;
            }

            snap.forEach(docSnap => {
                const d = docSnap.data();
                const id = docSnap.id;
                const criteria = ["Positionering voertuig", "Veiligheidsmaatregelen", "METHANE-methode", "Strafbaar feit", "Partners (VOA/Ambu)", "Opsporingstaken"];
                
                let feedbackHtml = "";
                criteria.forEach((label, index) => {
                    const isChecked = d[`feedback_${index}`] ? "checked" : "";
                    feedbackHtml += `
                        <label class="flex items-center p-1 hover:bg-white rounded transition cursor-pointer">
                            <input type="checkbox" class="mr-2" ${isChecked} onchange="updateFeedback('${id}', ${index}, this.checked)"> 
                            ${label}
                        </label>`;
                });

                lijst.innerHTML += `
                    <div class="bg-white border-2 p-6 mb-6 shadow-sm">
                        <div class="flex justify-between border-b pb-2 mb-4 bg-gray-50 px-2 py-1">
                            <span class="font-bold text-blue-900 uppercase text-xs">Student: ${d.student}</span>
                            <span class="text-[10px] text-gray-500 italic uppercase">Partner: ${d.partner || 'N.V.T.'}</span>
                        </div>
                        <div class="mb-6"><h4 class="text-[10px] font-bold uppercase text-gray-400">DAA Analyse</h4><p class="text-sm whitespace-pre-wrap text-gray-800">${d.daa}</p></div>
                        <div class="mb-6"><h4 class="text-[10px] font-bold uppercase text-gray-400">PV Bevindingen</h4><p class="text-sm whitespace-pre-wrap text-gray-800">${d.pv}</p></div>
                        <div class="bg-slate-100 p-4 border rounded text-[11px]">
                            <p class="font-bold mb-2 uppercase text-blue-900 tracking-tighter">Peer Feedback Aandachtspunten:</p>
                            <div class="grid grid-cols-2 gap-2">${feedbackHtml}</div>
                        </div>
                    </div>`;
            });
        }

        async function resetKlas(gekozenKlas) {
            if(!confirm(`AUTORISATIE: Alle data van klas ${gekozenKlas} wissen?`)) return;
            const q = query(collection(db, "casus_inzendingen"), where("klas", "==", gekozenKlas));
            const snap = await getDocs(q);
            const promises = snap.docs.map(d => deleteDoc(doc(db, "casus_inzendingen", d.id)));
            await Promise.all(promises);
            location.reload();
        }

        window.submitCasus = submitCasus; window.laadKlas = laadKlas; window.wijsPartnerToe = wijsPartnerToe; window.resetKlas = resetKlas; window.updateFeedback = updateFeedback;
    </script>

    <style>
        body { background-color: #f8f9fa; color: #1a1a1a; }
        .police-blue { background-color: #002d5e; }
        .police-border { border-color: #002d5e; }
        .text-police { color: #002d5e; }
    </style>
</head>
<body class="p-4 md:p-12">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-center text-xl font-bold uppercase tracking-[0.2em] text-police mb-10">Q2les1PVBevindingen</h1>

        <div class="bg-white border-y-4 police-border p-8 mb-12 text-center shadow-sm">
            <h2 class="text-[10px] font-black uppercase text-blue-900 mb-3 tracking-widest">Melding Operationeel Centrum</h2>
            <p class="italic text-lg text-gray-700 leading-relaxed">
                “Wilt u gaan naar kruising Vincent van Goghweg met de Westzijde in Zaandam. Hier is een motorrijder gevallen. Het slachtoffer is aanspreekbaar en heeft mogelijk letsel. De ambulance is onderweg en u heeft toestemming.”
            </p>
        </div>

        <div class="bg-white p-8 border border-gray-200 shadow-sm mb-16">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <input type="text" id="naam" placeholder="Voornaam Student" class="border p-2 text-sm outline-none focus:border-blue-900 bg-gray-50">
                <select id="klas" class="border p-2 text-sm outline-none focus:border-blue-900 bg-gray-50">
                    <option value="Delta">Delta</option><option value="Echo">Echo</option><option value="Foxtrot">Foxtrot</option><option value="Mike">Mike</option><option value="Lima">Lima</option>
                </select>
            </div>

            <div class="bg-slate-100 p-3 border-l-4 border-blue-900 mb-8 flex justify-between items-center text-xs">
                <span>Collega voor DAA: <span id="partnerDisplay" class="font-bold">-</span></span>
                <button onclick="wijsPartnerToe()" class="police-blue text-white px-4 py-1 uppercase text-[10px] font-bold">Wijs toe</button>
                <input type="hidden" id="hiddenPartner">
            </div>

            <div class="space-y-6">
                <div>
                    <label class="block text-[10px] font-bold uppercase mb-1 text-police">Doel Aanpak Analyse (DAA)</label>
                    <textarea id="daaText" rows="4" class="w-full border p-3 text-sm outline-none focus:bg-white bg-gray-50"></textarea>
                </div>
                <div>
                    <label class="block text-[10px] font-bold uppercase mb-1 text-police">PV van Bevindingen</label>
                    <textarea id="pvText" rows="6" class="w-full border p-3 text-sm outline-none focus:bg-white bg-gray-50"></textarea>
                </div>
                <button onclick="submitCasus()" class="w-full police-blue text-white font-bold py-4 uppercase tracking-[0.2em] text-sm hover:bg-slate-800 transition">Verzenden naar Systeem</button>
            </div>
        </div>

        <div class="border-t-2 border-gray-200 pt-10">
            <h2 class="text-center font-bold uppercase text-xs tracking-widest mb-8">Dataoverzicht & Feedback</h2>
            <div class="flex flex-wrap justify-center gap-6 mb-12">
                <div class="text-center space-y-2">
                    <button onclick="laadKlas('Delta')" class="w-24 border border-blue-900 py-2 text-[10px] font-bold hover:bg-blue-50">DELTA</button>
                    <button onclick="resetKlas('Delta')" class="block mx-auto text-[8px] text-red-500 font-bold uppercase">Reset</button>
                </div>
                <div class="text-center space-y-2">
                    <button onclick="laadKlas('Echo')" class="w-24 border border-blue-900 py-2 text-[10px] font-bold hover:bg-blue-50">ECHO</button>
                    <button onclick="resetKlas('Echo')" class="block mx-auto text-[8px] text-red-500 font-bold uppercase">Reset</button>
                </div>
                <div class="text-center space-y-2">
                    <button onclick="laadKlas('Foxtrot')" class="w-24 border border-blue-900 py-2 text-[10px] font-bold hover:bg-blue-50">FOXTROT</button>
                    <button onclick="resetKlas('Foxtrot')" class="block mx-auto text-[8px] text-red-500 font-bold uppercase">Reset</button>
                </div>
                <div class="text-center space-y-2">
                    <button onclick="laadKlas('Mike')" class="w-24 border border-blue-900 py-2 text-[10px] font-bold hover:bg-blue-50">MIKE</button>
                    <button onclick="resetKlas('Mike')" class="block mx-auto text-[8px] text-red-500 font-bold uppercase">Reset</button>
                </div>
                <div class="text-center space-y-2">
                    <button onclick="laadKlas('Lima')" class="w-24 border border-blue-900 py-2 text-[10px] font-bold hover:bg-blue-50">LIMA</button>
                    <button onclick="resetKlas('Lima')" class="block mx-auto text-[8px] text-red-500 font-bold uppercase">Reset</button>
                </div>
            </div>
            <div id="feedbackLijst" class="max-w-3xl mx-auto pb-20"></div>
        </div>
    </div>
</body>
</html>
