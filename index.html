<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BTV Dashboard - Ongeval Zaandam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp, collection, addDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBRq1HFmhrpW_EMMZwpURrbTArz-L5iWT4",
            authDomain: "pvaangifteinleveren-77dbe.firebaseapp.com",
            projectId: "pvaangifteinleveren-77dbe",
            storageBucket: "pvaangifteinleveren-77dbe.firebasestorage.app",
            messagingSenderId: "20239054410",
            appId: "1:20239054410:web:264b3c759312248d9f18b3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const LES_ID = "btv_zaandam_2026"; 

        window.connectKlas = () => {
            const klas = document.getElementById('uKlas').value;
            if(!klas) return;
            onSnapshot(doc(db, "live_daa", LES_ID + "_" + klas), (s) => {
                const field = document.getElementById('daaInput');
                if(s.exists() && document.activeElement !== field) field.value = s.data().t;
            });
            const q = query(collection(db, "btv_data"), where("lesId", "==", LES_ID), where("klas", "==", klas), orderBy("ts", "desc"));
            onSnapshot(q, (sn) => {
                const feed = document.getElementById('liveFeed');
                feed.innerHTML = "";
                sn.forEach(d => {
                    const data = d.data();
                    feed.innerHTML += `<div class="bg-white p-4 mb-3 rounded-lg border-l-8 border-blue-900 shadow-md">
                        <div class="flex justify-between font-black text-[10px] text-blue-900 uppercase mb-2">
                            <span>${data.naam}</span><span>${data.type}</span>
                        </div>
                        <p class="text-slate-800 leading-relaxed">${data.txt}</p>
                    </div>`;
                });
            });
            setupWhiteboard('c1', LES_ID + '_bord1_' + klas, db);
            setupWhiteboard('c2', LES_ID + '_bord2_' + klas, db);
        };

        window.sendData = async (type, elementId) => {
            const txt = document.getElementById(elementId).value;
            const naam = document.getElementById('uNaam').value.trim();
            const klas = document.getElementById('uKlas').value;
            if(!naam || !klas) return alert("Vul eerst je naam in en kies een eenheid.");
            if(!txt) return alert("Veld is leeg.");
            if(type === 'DAA') {
                await setDoc(doc(db, "live_daa", LES_ID + "_" + klas), { t: txt, ts: serverTimestamp() });
            } else {
                await addDoc(collection(db, "btv_data"), { lesId: LES_ID, naam, klas, type, txt, ts: serverTimestamp() });
                alert("Verzonden naar de feed!");
            }
        };
    </script>

    <script>
        const criteria = [
            ["ik", "hield"], ["ik", "zag"], ["ik", "hoorde"] 
        ];

        function checkZinnen() {
            const tekst = document.getElementById('zinInput').value.toLowerCase();
            let score = 0;
            criteria.forEach((woorden, index) => {
                const indicator = document.getElementById(`check-${index + 1}`);
                if(!indicator) return;
                const isCorrect = woorden.every(woord => tekst.includes(woord));
                if (isCorrect) {
                    indicator.className = "w-4 h-4 rounded-full bg-green-500 shadow-[0_0_10px_green]";
                    score++;
                } else { 
                    indicator.className = "w-4 h-4 rounded-full bg-slate-300"; 
                }
            });
            document.getElementById('liveScore').innerText = score;
        }

        function setupWhiteboard(id, docName, db) {
            const c = document.getElementById(id); const ctx = c.getContext('2d');
            c.width = c.offsetWidth; c.height = 250;
            let draw = false; ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.strokeStyle = '#002d5e';
            const getP = (e) => { const r = c.getBoundingClientRect(); return { x: (e.touches?.[0].clientX || e.clientX) - r.left, y: (e.touches?.[0].clientY || e.clientY) - r.top }; };
            c.onmousedown = (e) => { draw=true; ctx.beginPath(); const p=getP(e); ctx.moveTo(p.x, p.y); };
            c.onmousemove = (e) => { if(!draw) return; const p=getP(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
            const stop = async () => { if(!draw) return; draw=false; 
                const { setDoc, doc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                await setDoc(doc(db, "whiteboards", docName), { img: c.toDataURL('image/webp', 0.5) });
            };
            window.addEventListener('mouseup', stop);
            // GUM FUNCTIE
            window['clear_'+id] = () => { ctx.clearRect(0,0,c.width,c.height); stop(); };

            c.addEventListener('touchstart', (e) => { draw=true; ctx.beginPath(); const p=getP(e); ctx.moveTo(p.x, p.y); e.preventDefault(); });
            c.addEventListener('touchmove', (e) => { if(!draw) return; const p=getP(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); });
            c.addEventListener('touchend', stop);
        }
    </script>

    <style>
        .bg-police { background-color: #002d5e; }
        section { margin-bottom: 2.5rem; }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-900 pb-20 p-4">

    <div class="max-w-4xl mx-auto">
        
        <header class="bg-police text-white p-6 rounded-2xl shadow-xl mb-8 border-b-4 border-yellow-500">
            <h1 class="font-black italic uppercase text-xl mb-4">BTV Dashboard: Verkeersongeval Zaandam</h1>
            <div class="grid md:grid-cols-2 gap-4">
                <input type="text" id="uNaam" placeholder="Jouw Voornaam" class="w-full bg-white/10 border border-white/30 p-3 rounded-lg font-bold text-white placeholder-white/50 outline-none focus:bg-white/20">
                <select id="uKlas" onchange="connectKlas()" class="w-full bg-white text-police p-3 rounded-lg font-bold outline-none">
                    <option value="">-- Kies Eenheid --</option>
                    <option>Delta</option><option>Echo</option><option>Foxtrot</option><option>Mike</option><option>Lima</option>
                </select>
            </div>
        </header>

        <section class="bg-red-700 text-white p-6 rounded-2xl shadow-xl border-l-8 border-yellow-500">
            <h2 class="font-black uppercase text-xs mb-3 text-yellow-400 tracking-widest">Melding Operationeel Centrum (OC):</h2>
            <div class="bg-black/20 p-4 rounded-xl font-mono text-sm italic mb-6 leading-relaxed border border-white/10">
                ‚ÄúWilt u gaan naar kruising Vincent van Goghweg met de Westzijde in Zaandam. Hier is een motorrijder gevallen. Het slachtoffer is aanspreekbaar en heeft mogelijk letsel. De ambulance is onderweg en u heeft toestemming.‚Äù
            </div>
            
            <div class="grid grid-cols-3 gap-3">
                <div class="aspect-square bg-white/10 rounded-lg border border-white/20 flex flex-col items-center justify-center p-2 text-center">
                    <span class="text-[8px] font-bold uppercase mb-2">Locatiekaart</span>
                    <img src="https://via.placeholder.com/150?text=Kaart" class="rounded shadow-sm">
                </div>
                <div class="aspect-square bg-white/10 rounded-lg border border-white/20 flex flex-col items-center justify-center p-2 text-center">
                    <span class="text-[8px] font-bold uppercase mb-2">Bord J2</span>
                    <img src="https://via.placeholder.com/150?text=Bord+J2" class="rounded shadow-sm">
                </div>
                <div class="aspect-square bg-white/10 rounded-lg border border-white/20 flex flex-col items-center justify-center p-2 text-center">
                    <span class="text-[8px] font-bold uppercase mb-2">Overzicht</span>
                    <img src="https://via.placeholder.com/150?text=Foto" class="rounded shadow-sm">
                </div>
            </div>
        </section>

        <section class="bg-white p-6 rounded-2xl shadow-md border-t-4 border-police">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-black uppercase text-sm text-police">Opdracht 1: Situatieschets</h2>
                <button onclick="clear_c1()" class="bg-red-100 text-red-600 px-3 py-1 rounded-lg text-[10px] font-bold uppercase hover:bg-red-200">üóëÔ∏è Gum / Wis</button>
            </div>
            <canvas id="c1" class="w-full bg-slate-50 border-2 rounded-xl mb-4 h-[250px] touch-none"></canvas>
            <textarea id="t1" class="w-full border-2 p-4 rounded-xl text-sm mb-4" placeholder="Toelichting bij je situatieschets..."></textarea>
            <button onclick="sendData('Bord 1', 't1')" class="w-full bg-police text-white py-4 rounded-xl font-black uppercase text-xs">Verstuur Deel 1</button>
        </section>

        <section class="bg-white p-6 rounded-2xl shadow-md border-t-4 border-police">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-black uppercase text-sm text-police">Opdracht 2: Positie Eenheid & Afzetting</h2>
                <button onclick="clear_c2()" class="bg-red-100 text-red-600 px-3 py-1 rounded-lg text-[10px] font-bold uppercase hover:bg-red-200">üóëÔ∏è Gum / Wis</button>
            </div>
            <canvas id="c2" class="w-full bg-slate-50 border-2 rounded-xl mb-4 h-[250px] touch-none"></canvas>
            <textarea id="t2" class="w-full border-2 p-4 rounded-xl text-sm mb-4" placeholder="Welke maatregelen heb je genomen?"></textarea>
            <button onclick="sendData('Bord 2', 't2')" class="w-full bg-police text-white py-4 rounded-xl font-black uppercase text-xs">Verstuur Deel 2</button>
        </section>

        <section class="bg-white p-6 rounded-2xl shadow-md border-t-4 border-police">
            <div class="flex justify-between items-center mb-6">
                <h2 class="font-black uppercase text-sm text-police italic underline">Taaloefening</h2>
                <div class="bg-green-600 text-white px-4 py-2 rounded-full font-black text-xs shadow-lg">Score: <span id="liveScore">0</span> / 3</div>
            </div>
            <div class="space-y-3 mb-6 italic text-[10px] text-slate-500">
                <p>Maak de zinnen actief (Ik + verleden tijd):</p>
                <script>
                    const zinnen = [
                        "De kruising is door mij direct afgezet.",
                        "De ambulance is door mij via het OC opgeroepen.",
                        "Het verkeer is door mij op afstand gehouden."
                    ];
                    zinnen.forEach((s, i) => document.write(`
                        <div class="flex items-center gap-4 font-bold text-slate-600 bg-slate-50 p-3 rounded-lg border">
                            <span id="check-${i+1}" class="w-4 h-4 rounded-full bg-slate-300 shrink-0"></span>
                            <span>${i+1}. ${s}</span>
                        </div>
                    `));
                </script>
            </div>
            <textarea id="zinInput" oninput="checkZinnen()" class="w-full border-2 p-5 rounded-2xl text-sm h-48 outline-none" placeholder="Typ hier de actieve zinnen..."></textarea>
            <button onclick="sendData('Taaloefening', 'zinInput')" class="w-full bg-police text-white py-4 mt-4 rounded-xl font-black uppercase text-xs">Verstuur Zinnen</button>
        </section>

        <section class="bg-yellow-400 p-1 rounded-2xl shadow-2xl">
            <div class="bg-yellow-50 p-6 rounded-xl">
                <h2 class="font-black uppercase text-sm mb-4 text-yellow-900 italic text-center underline tracking-tighter">LIVE DAA OVERLEG (SYNC)</h2>
                <textarea id="daaInput" oninput="sendData('DAA', 'daaInput')" class="w-full border-2 border-yellow-200 p-6 rounded-xl text-sm h-48 shadow-inner outline-none focus:bg-white" placeholder="Werk hier samen aan Doel - Aanpak - Analyse..."></textarea>
            </div>
        </section>

        <section class="mt-16">
            <div class="flex items-center gap-4 mb-6">
                <div class="h-px bg-slate-300 flex-1"></div>
                <h2 class="font-black uppercase text-[10px] text-slate-400 tracking-[0.2em]">Live Inzendingen</h2>
                <div class="h-px bg-slate-300 flex-1"></div>
            </div>
            <div id="liveFeed" class="space-y-4 text-left"></div>
        </section>

    </div>
</body>
</html>
