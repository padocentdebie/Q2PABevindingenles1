<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q2les1PVBevindingen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBRq1HFmhrpW_EMMZwpURrbTArz-L5iWT4",
            authDomain: "pvaangifteinleveren-77dbe.firebaseapp.com",
            databaseURL: "https://pvaangifteinleveren-77dbe-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pvaangifteinleveren-77dbe",
            storageBucket: "pvaangifteinleveren-77dbe.firebasestorage.app",
            messagingSenderId: "20239054410",
            appId: "1:20239054410:web:264b3c759312248d9f18b3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.onload = () => {
            alert("VEILIGHEIDSMELDING: U betreedt een beveiligde werkomgeving. Ga vertrouwelijk om met de gegevens van medestudenten.");
        };

        // Nieuwe functie om visueel te bevestigen dat velden zijn ingevuld
        window.checkInputs = () => {
            const naam = document.getElementById('naam').value;
            const status = document.getElementById('inputStatus');
            if (naam.length > 2) {
                status.innerHTML = "✅ Gegevens gereed";
                status.classList.remove('text-gray-400');
                status.classList.add('text-green-600');
            } else {
                status.innerHTML = "⚠️ Voer naam in";
                status.classList.add('text-gray-400');
            }
        };

        async function wijsPartnerToe() {
            const klas = document.getElementById('klas').value;
            const eigenNaam = document.getElementById('naam').value;
            const partnerDisplay = document.getElementById('partnerDisplay');
            
            if(!eigenNaam || eigenNaam.length < 2) {
                return alert("FOUT: Voer eerst uw eigen voornaam in bij 'Naam Student'.");
            }

            partnerDisplay.innerText = "Zoeken in database...";
            try {
                const q = query(collection(db, "casus_inzendingen"), where("klas", "==", klas));
                const snap = await getDocs(q);
                let studenten = [];
                snap.forEach(docSnap => {
                    const data = docSnap.data();
                    // Voorkom dat je aan jezelf gekoppeld wordt
                    if(data.student.toLowerCase() !== eigenNaam.toLowerCase()) {
                        studenten.push(data.student);
                    }
                });

                if(studenten.length > 0) {
                    const partner = studenten[Math.floor(Math.random() * studenten.length)];
                    partnerDisplay.innerText = partner;
                    document.getElementById('hiddenPartner').value = partner;
                } else {
                    partnerDisplay.innerText = "Geen klasgenoten gevonden. Vraag of anderen al hebben ingeleverd.";
                    alert("INFO: Er zijn nog geen andere inzendingen in klas " + klas + ". Koppelen is pas mogelijk als klasgenoten hun werk hebben ingeleverd.");
                }
            } catch (e) { 
                console.error(e);
                partnerDisplay.innerText = "Fout bij verbinding.";
            }
        }

        async function submitCasus() {
            const naam = document.getElementById('naam').value;
            const klas = document.getElementById('klas').value;
            const partner = document.getElementById('hiddenPartner').value;
            const daa = document.getElementById('daaText').value;
            const pv = document.getElementById('pvText').value;
            
            if(!naam || !daa || !pv) return alert("FOUT: Naam, DAA en PV zijn verplicht.");
            
            if(confirm("Bevestig: U staat op het punt uw werk definitief in te leveren.")) {
                try {
                    await addDoc(collection(db, "casus_inzendingen"), {
                        student: naam, partner: partner || "Nog niet gekoppeld", klas, daa, pv, timestamp: serverTimestamp()
                    });
                    alert("Inzending succesvol opgeslagen.");
                    location.reload();
                } catch (e) { console.error(e); }
            }
        }

        async function laadKlas(gekozenKlas) {
            const lijst = document.getElementById('feedbackLijst');
            lijst.innerHTML = "<p class='text-center p-4 italic'>Inzendingen worden geladen...</p>";
            const q = query(collection(db, "casus_inzendingen"), where("klas", "==", gekozenKlas));
            const snap = await getDocs(q);
            lijst.innerHTML = "";
            if(snap.empty) {
                lijst.innerHTML = "<p class='text-center p-4 text-gray-500'>Geen inzendingen gevonden voor " + gekozenKlas + ".</p>";
                return;
            }
            snap.forEach(docSnap => {
                const d = docSnap.data();
                const id = docSnap.id;
                const criteria = ["Positionering voertuig", "Veiligheidsmaatregelen", "METHANE-methode", "Strafbaar feit", "Partners (VOA/Ambu)", "Opsporingstaken"];
                let feedbackHtml = "";
                criteria.forEach((label, index) => {
                    const isChecked = d[`feedback_${index}`] ? "checked" : "";
                    feedbackHtml += `<label class="flex items-center p-1 cursor-pointer no-print"><input type="checkbox" class="mr-2" ${isChecked} onchange="window.updateFeedback('${id}', ${index}, this.checked)"> ${label}</label>`;
                });

                lijst.innerHTML += `
                    <div class="bg-white border-2 p-8 mb-8 shadow-sm text-left print-section">
                        <div class="flex justify-between border-b pb-2 mb-6 bg-gray-50 px-2 py-1 print:bg-white">
                            <span class="font-bold text-blue-900 uppercase text-xs">Auteur: ${d.student}</span>
                            <span class="text-[10px] text-gray-500 italic uppercase">Collega voor DAA: ${d.partner}</span>
                        </div>
                        <div class="mb-8">
                            <h4 class="text-[10px] font-bold uppercase text-gray-400 mb-2">Doel Aanpak Analyse (DAA)</h4>
                            <div class="text-sm whitespace-pre-wrap text-gray-800 font-serif">${d.daa}</div>
                        </div>
                        <div class="mb-8">
                            <h4 class="text-[10px] font-bold uppercase text-gray-400 mb-2">Proces-verbaal van Bevindingen</h4>
                            <div class="text-sm whitespace-pre-wrap text-gray-800 font-serif">${d.pv}</div>
                        </div>
                        <div class="bg-slate-50 p-4 border rounded text-[11px] no-print mb-4">
                            <p class="font-bold mb-2 uppercase text-blue-900">Peer Feedback:</p>
                            <div class="grid grid-cols-2 gap-1">${feedbackHtml}</div>
                        </div>
                        <button onclick="window.print()" class="no-print bg-blue-900 text-white px-4 py-2 text-[10px] font-bold uppercase hover:bg-black transition">Exporteer als PV</button>
                    </div>`;
            });
        }

        window.updateFeedback = async (docId, criteriaIndex, isChecked) => {
            try {
                const docRef = doc(db, "casus_inzendingen", docId);
                await updateDoc(docRef, { [`feedback_${criteriaIndex}`]: isChecked });
            } catch (e) { console.error(e); }
        };

        window.submitCasus = submitCasus; window.laadKlas = laadKlas; window.wijsPartnerToe = wijsPartnerToe;
    </script>

    <style>
        body { background-color: #f8f9fa; color: #1a1a1a; font-family: ui-sans-serif, system-ui, sans-serif; }
        .police-blue { background-color: #002d5e; }
        .police-border { border-color: #002d5e; }
        .text-police { color: #002d5e; }
        @media print {
            .no-print { display: none !important; }
            .print-section { border: none !important; padding: 1cm !important; width: 100% !important; }
        }
    </style>
</head>
<body class="p-4 md:p-12 text-left">

    <div class="max-w-4xl mx-auto">
        <header class="no-print">
            <h1 class="text-center text-xl font-bold uppercase tracking-[0.2em] text-police mb-10">Q2les1PVBevindingen</h1>

            <div class="bg-slate-800 text-white p-6 mb-1 rounded-t-lg shadow-md border-b-4 border-blue-500">
                <h3 class="text-xs font-bold uppercase tracking-widest mb-3 text-blue-300">Instructie Oefenmodule</h3>
                <ul class="text-[11px] space-y-2 list-disc list-inside text-gray-200">
                    <li>Vul eerst uw <span class="text-white font-bold underline">Naam</span> en <span class="text-white font-bold underline">Klasgroep</span> in onderaan dit scherm.</li>
                    <li>Gebruik de knop <span class="text-white font-bold italic">"Koppel Collega"</span>. (Let op: Dit werkt alleen als klasgenoten al hebben ingeleverd!)</li>
                    <li>Bestudeer de OC-melding en werk de <span class="text-white font-bold">DAA</span> en het <span class="text-white font-bold">PV</span> uit.</li>
                </ul>
            </div>

            <div class="bg-white border-b-4 police-border p-8 mb-12 shadow-sm">
                <h2 class="text-[10px] font-black uppercase text-blue-900 mb-3 tracking-widest text-center">Bericht Operationeel Centrum</h2>
                <p class="italic text-lg text-gray-700 leading-relaxed mb-6 text-center">
                    “Wilt u gaan naar kruising Vincent van Goghweg met de Westzijde, 1506 GC Zaandam. Hier is een motorrijder gevallen. Het slachtoffer is aanspreekbaar en heeft mogelijk letsel.”
                </p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-8 border-t pt-8">
                    <div class="text-center"><img src="bord50.png" class="mx-auto h-32 object-contain border rounded"><p class="text-[8px] mt-1 text-gray-400 font-bold uppercase">RVV A1</p></div>
                    <div class="text-center"><img src="kruispuntgooglemaps.png" class="mx-auto h-32 object-cover border rounded"><p class="text-[8px] mt-1 text-gray-400 font-bold uppercase">Streetview</p></div>
                    <div class="text-center"><img src="overzichtkruispunt.png" class="mx-auto h-32 object-cover border rounded"><p class="text-[8px] mt-1 text-gray-400 font-bold uppercase">Overzicht</p></div>
                </div>
            </div>

            <div class="bg-white p-8 border border-gray-200 shadow-sm mb-16">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                    <div>
                        <label class="block text-[10px] font-bold uppercase mb-1 text-gray-400">Naam Student</label>
                        <input type="text" id="naam" oninput="checkInputs()" placeholder="Voornaam" class="w-full border p-2 text-sm outline-none focus:border-blue-900 bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold uppercase mb-1 text-gray-400">Klasgroep</label>
                        <select id="klas" class="w-full border p-2 text-sm outline-none focus:border-blue-900 bg-gray-50">
                            <option value="Delta">Delta</option><option value="Echo">Echo</option><option value="Foxtrot">Foxtrot</option><option value="Mike">Mike</option><option value="Lima">Lima</option>
                        </select>
                    </div>
                </div>
                <div id="inputStatus" class="text-[10px] font-bold uppercase mb-6 text-gray-400">⚠️ Voer naam in</div>

                <div class="bg-slate-100 p-3 border-l-4 border-blue-900 mb-8 flex justify-between items-center text-xs">
                    <span>Gekoppelde collega: <span id="partnerDisplay" class="font-bold text-blue-900">-</span></span>
                    <button onclick="wijsPartnerToe()" class="police-blue text-white px-4 py-1 uppercase text-[10px] font-bold hover:bg-blue-800 transition">Koppel Collega</button>
                    <input type="hidden" id="hiddenPartner">
                </div>

                <div class="space-y-6">
                    <textarea id="daaText" placeholder="1. Doel Aanpak Analyse (DAA)" rows="4" class="w-full border p-3 text-sm bg-gray-50 focus:bg-white outline-none"></textarea>
                    <textarea id="pvText" placeholder="2. Proces-verbaal van Bevindingen" rows="6" class="w-full border p-3 text-sm bg-gray-50 focus:bg-white outline-none"></textarea>
                    <button onclick="submitCasus()" class="w-full police-blue text-white font-bold py-4 uppercase tracking-[0.2em] text-sm hover:bg-black transition">Inleveren</button>
                </div>
            </div>
        </header>

        <div class="border-t-2 border-gray-200 pt-10 no-print">
            <h2 class="text-center font-bold uppercase text-xs tracking-widest mb-8 text-police">Peer Feedback & Resultaten</h2>
            <div class="flex flex-wrap justify-center gap-4 mb-12">
                <button onclick="laadKlas('Delta')" class="w-20 border border-blue-900 py-1 text-[9px] font-bold">DELTA</button>
                <button onclick="laadKlas('Echo')" class="w-20 border border-blue-900 py-1 text-[9px] font-bold">ECHO</button>
                <button onclick="laadKlas('Foxtrot')" class="w-20 border border-blue-900 py-1 text-[9px] font-bold">FOXTROT</button>
                <button onclick="laadKlas('Mike')" class="w-20 border border-blue-900 py-1 text-[9px] font-bold">MIKE</button>
                <button onclick="laadKlas('Lima')" class="w-20 border border-blue-900 py-1 text-[9px] font-bold">LIMA</button>
            </div>
        </div>
        
        <div id="feedbackLijst" class="max-w-3xl mx-auto pb-20"></div>
    </div>
</body>
</html>
