<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q2les1PVBevindingen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBRq1HFmhrpW_EMMZwpURrbTArz-L5iWT4",
            authDomain: "pvaangifteinleveren-77dbe.firebaseapp.com",
            databaseURL: "https://pvaangifteinleveren-77dbe-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pvaangifteinleveren-77dbe",
            storageBucket: "pvaangifteinleveren-77dbe.firebasestorage.app",
            messagingSenderId: "20239054410",
            appId: "1:20239054410:web:264b3c759312248d9f18b3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        async function wijsPartnerToe() {
            const klas = document.getElementById('klas').value;
            const eigenNaam = document.getElementById('naam').value.trim();
            const partnerDisplay = document.getElementById('partnerDisplay');
            
            if(!eigenNaam) return alert("Voer eerst uw naam in.");

            partnerDisplay.innerText = "Systeem doorzoeken...";
            
            try {
                const q = query(collection(db, "casus_inzendingen"), where("klas", "==", klas));
                const snap = await getDocs(q);
                let studenten = [];
                
                snap.forEach(docSnap => {
                    const sNaam = docSnap.data().student;
                    if(sNaam.toLowerCase() !== eigenNaam.toLowerCase()) {
                        studenten.push(sNaam);
                    }
                });

                if(studenten.length > 0) {
                    const partner = studenten[Math.floor(Math.random() * studenten.length)];
                    partnerDisplay.innerText = partner;
                    document.getElementById('hiddenPartner').value = partner;
                } else {
                    partnerDisplay.innerText = "Geen andere studenten gevonden in " + klas;
                    alert("Status: U bent momenteel de enige actieve student in deze klas. De partner-functie werkt zodra een tweede student inlogt/indient.");
                }
            } catch (e) { console.error(e); }
        }

        async function submitCasus() {
            const naam = document.getElementById('naam').value.trim();
            const klas = document.getElementById('klas').value;
            const partner = document.getElementById('hiddenPartner').value;
            const daa = document.getElementById('daaText').value;
            const pv = document.getElementById('pvText').value;
            
            if(!naam || !daa || !pv) return alert("Naam, DAA en PV zijn verplicht.");
            
            try {
                await addDoc(collection(db, "casus_inzendingen"), {
                    student: naam, partner: partner || "Nog geen partner", klas, daa, pv, timestamp: serverTimestamp()
                });
                alert("Inzending opgeslagen!");
                location.reload();
            } catch (e) { console.error(e); }
        }

        window.laadKlas = async (gekozenKlas) => {
            const lijst = document.getElementById('feedbackLijst');
            lijst.innerHTML = "Laden...";
            const q = query(collection(db, "casus_inzendingen"), where("klas", "==", gekozenKlas));
            const snap = await getDocs(q);
            lijst.innerHTML = "";
            snap.forEach(docSnap => {
                const d = docSnap.data();
                lijst.innerHTML += `
                    <div class="bg-white border p-6 mb-4 shadow-sm text-left">
                        <p class="text-xs font-bold text-blue-900">Auteur: ${d.student} | Partner: ${d.partner}</p>
                        <div class="mt-4"><strong>DAA:</strong><p class="text-sm whitespace-pre-wrap">${d.daa}</p></div>
                        <div class="mt-4"><strong>PV:</strong><p class="text-sm whitespace-pre-wrap">${d.pv}</p></div>
                    </div>`;
            });
        };

        window.submitCasus = submitCasus; window.wijsPartnerToe = wijsPartnerToe;
    </script>
</head>
<body class="bg-gray-100 p-8 font-sans">
    <div class="max-w-4xl mx-auto">
        <div class="bg-slate-800 text-white p-6 mb-4 rounded shadow border-b-4 border-blue-500">
            <h3 class="text-xs font-bold uppercase tracking-widest mb-2">Stappenplan</h3>
            <p class="text-xs">1. Vul je naam in. 2. Klik op 'Koppel' (werkt alleen als anderen ook in de lijst staan). 3. Schrijf je PV.</p>
        </div>

        <div class="bg-white p-8 border-b-4 border-blue-900 shadow mb-8">
             <h2 class="text-center font-bold text-blue-900 mb-4">BERICHT OPERATIONEEL CENTRUM</h2>
             <p class="italic text-center text-gray-700">"Motorrijder gevallen kruising Vincent van Goghweg/Westzijde Zaandam. Ambulance onderweg."</p>
             <div class="grid grid-cols-3 gap-2 mt-6">
                <img src="bord50.png" class="h-24 mx-auto object-contain border">
                <img src="kruispuntgooglemaps.png" class="h-24 mx-auto object-cover border">
                <img src="overzichtkruispunt.png" class="h-24 mx-auto object-cover border">
             </div>
        </div>

        <div class="bg-white p-8 shadow rounded border border-gray-200 mb-8">
            <div class="flex gap-4 mb-6">
                <input type="text" id="naam" placeholder="Je naam" class="flex-1 border p-2 text-sm outline-none">
                <select id="klas" class="border p-2 text-sm">
                    <option value="Delta">Delta</option><option value="Echo">Echo</option><option value="Foxtrot">Foxtrot</option>
                </select>
            </div>

            <div class="bg-blue-50 p-3 mb-6 flex justify-between items-center text-xs border-l-4 border-blue-900">
                <span>Gekoppelde collega: <span id="partnerDisplay" class="font-bold">-</span></span>
                <button onclick="wijsPartnerToe()" class="bg-blue-900 text-white px-3 py-1 rounded uppercase font-bold text-[10px]">Koppel</button>
                <input type="hidden" id="hiddenPartner">
            </div>

            <textarea id="daaText" placeholder="DAA Analyse..." class="w-full border p-3 text-sm mb-4 h-24 bg-gray-50"></textarea>
            <textarea id="pvText" placeholder="PV van Bevindingen..." class="w-full border p-3 text-sm mb-4 h-40 bg-gray-50"></textarea>
            
            <button onclick="submitCasus()" class="w-full bg-blue-900 text-white font-bold py-3 uppercase tracking-widest hover:bg-black transition">Inleveren</button>
        </div>

        <div class="text-center">
            <h4 class="text-xs font-bold uppercase text-gray-500 mb-4 tracking-widest">Bekijk resultaten klas</h4>
            <div class="flex justify-center gap-2 mb-8">
                <button onclick="laadKlas('Delta')" class="bg-white border border-blue-900 px-4 py-1 text-[10px] font-bold">DELTA</button>
                <button onclick="laadKlas('Echo')" class="bg-white border border-blue-900 px-4 py-1 text-[10px] font-bold">ECHO</button>
                <button onclick="laadKlas('Foxtrot')" class="bg-white border border-blue-900 px-4 py-1 text-[10px] font-bold">FOXTROT</button>
            </div>
            <div id="feedbackLijst"></div>
        </div>
    </div>
</body>
</html>
