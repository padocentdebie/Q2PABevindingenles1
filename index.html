<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BTV Dashboard - Zaandam 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, serverTimestamp, collection, addDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBRq1HFmhrpW_EMMZwpURrbTArz-L5iWT4",
            authDomain: "pvaangifteinleveren-77dbe.firebaseapp.com",
            projectId: "pvaangifteinleveren-77dbe",
            storageBucket: "pvaangifteinleveren-77dbe.firebasestorage.app",
            messagingSenderId: "20239054410",
            appId: "1:20239054410:web:264b3c759312248d9f18b3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const LES_ID = "btv_zaandam_volledig";

        window.startLes = () => {
            const naam = document.getElementById('uNaam').value.trim();
            const klas = document.getElementById('uKlas').value;
            if(!naam || !klas) return alert("Vul voornaam en eenheid in.");
            document.getElementById('loginOverlay').style.display='none';
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('displayKlas').innerText = klas;
            initLive(klas, naam);
        };

        async function initLive(klas, naam) {
            setupWhiteboard('c1', LES_ID + '_bord1_' + klas, db);
            setupWhiteboard('c2', LES_ID + '_bord2_' + klas, db);
            
            const q = query(collection(db, "btv_2026"), where("klas", "==", klas), orderBy("ts", "desc"));
            onSnapshot(q, (sn) => {
                const feed = document.getElementById('liveFeed');
                feed.innerHTML = "";
                sn.forEach(d => {
                    const data = d.data();
                    feed.innerHTML += `
                        <div class="bg-white p-4 mb-4 rounded-xl border-l-8 border-blue-900 shadow-md">
                            <div class="flex justify-between font-black text-[10px] text-blue-900 uppercase mb-2">
                                <span>${data.naam}</span><span>${data.type}</span>
                            </div>
                            <p class="text-slate-800 italic mb-2">"${data.txt}"</p>
                            ${data.feedback ? `
                                <div class="mt-3 p-2 bg-slate-50 border-t border-slate-200 rounded">
                                    <span class="text-[9px] font-black text-blue-800 uppercase block mb-1">Feedback Punten:</span>
                                    <p class="text-[10px] text-slate-600 font-bold italic">${data.feedback}</p>
                                </div>` : ''}
                        </div>`;
                });
            });
        }

        window.sendData = async (type, elementId) => {
            const txt = document.getElementById(elementId).value;
            const naam = document.getElementById('uNaam').value;
            const klas = document.getElementById('uKlas').value;
            if(!txt) return alert("Veld is leeg.");
            
            const gekozen = Array.from(document.querySelectorAll('#feedbackChecklist input:checked')).map(c => c.value);
            const feedbackString = gekozen.join(", ");
            
            await addDoc(collection(db, "btv_2026"), { 
                naam, klas, type, txt, ts: serverTimestamp(),
                feedback: feedbackString
            });
            alert(type + " is succesvol verzonden!");
        };

        window.resetAlles = () => {
            if(confirm("Weet je zeker dat je alle tekstvelden wilt leegmaken?")) {
                document.querySelectorAll('textarea').forEach(t => t.value = "");
                document.getElementById('liveScore').innerText = "0";
                document.querySelectorAll('#feedbackChecklist input').forEach(c => c.checked = false);
                alert("Alles is gereset.");
            }
        };
    </script>

    <script>
        const criteria = [
            ["ik legde", "zijligging"], ["ik zette", "kruising", "af"], ["ik riep", "ambulance"],
            ["ik sprak", "slachtoffer", "aan"], ["ik hield", "verkeer", "afstand"], ["ik plaatste", "motorfiets"],
            ["ik bekeek", "letsel"], ["ik verwijderde", "helm", "niet"], ["ik zette", "getuigen", "apart"],
            ["ik noteerde", "rugklachten"], ["ik controleerde", "bewustzijn"], ["ik markeerde", "vloeistoffen"],
            ["ik vroeg", "gegevens", "op"], ["ik maakte", "route", "vrij"], ["ik stelde", "pv", "op"]
        ];

        function checkZinnen() {
            const tekst = document.getElementById('zinInput').value.toLowerCase();
            let score = 0;
            criteria.forEach((woorden, index) => {
                const indicator = document.getElementById(`check-${index + 1}`);
                const isCorrect = woorden.every(woord => tekst.includes(woord));
                if(indicator) indicator.className = isCorrect ? "w-3 h-3 rounded-full bg-green-500 shadow-[0_0_8px_green]" : "w-3 h-3 rounded-full bg-slate-300";
                if (isCorrect) score++;
            });
            document.getElementById('liveScore').innerText = score;
        }

        function setupWhiteboard(id, docName, db) {
            const c = document.getElementById(id); const ctx = c.getContext('2d');
            c.width = c.offsetWidth; c.height = 180;
            let draw = false; ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#002d5e';
            const getP = (e) => { const r = c.getBoundingClientRect(); return { x: (e.touches?.[0].clientX || e.clientX) - r.left, y: (e.touches?.[0].clientY || e.clientY) - r.top }; };
            c.onmousedown = (e) => { draw=true; ctx.beginPath(); const p=getP(e); ctx.moveTo(p.x, p.y); };
            c.onmousemove = (e) => { if(!draw) return; const p=getP(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
            window['clear_'+id] = () => { ctx.clearRect(0,0,c.width,c.height); ctx.beginPath(); };
            const stop = async () => { if(!draw) return; draw=false; };
            window.addEventListener('mouseup', stop);
            c.addEventListener('touchstart', (e) => { draw=true; ctx.beginPath(); const p=getP(e); ctx.moveTo(p.x, p.y); e.preventDefault(); }, {passive:false});
            c.addEventListener('touchmove', (e) => { if(!draw) return; const p=getP(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); }, {passive:false});
        }
    </script>

    <style>
        .bg-police { background-color: #002d5e; }
        .shadow-police { box-shadow: 0 4px 15px rgba(0, 45, 94, 0.2); }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 pb-20 p-4">

    <div id="loginOverlay" class="fixed inset-0 bg-police z-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded shadow-2xl w-full max-w-lg border-t-8 border-yellow-500">
            <h1 class="font-black text-2xl mb-4 text-police italic uppercase">Instructie</h1>
            <p class="text-sm text-slate-600 mb-6">Log in met je <b>voornaam</b> en kies de juiste <b>eenheid</b>.</p>
            <input type="text" id="uNaam" placeholder="Jouw Voornaam" class="w-full border-2 p-4 rounded-lg mb-4 font-bold outline-none focus:border-police text-center">
            <select id="uKlas" class="w-full border-2 p-4 rounded-lg mb-8 font-bold outline-none focus:border-police text-center">
                <option value="">-- Kies Eenheid --</option>
                <option>Delta</option><option>Echo</option><option>Foxtrot</option><option>Kilo</option><option>Lima</option><option>Mike</option>
            </select>
            <button onclick="startLes()" class="w-full bg-police text-white p-5 rounded-lg font-black uppercase tracking-widest hover:bg-blue-900 transition-all">Start Dashboard</button>
        </div>
    </div>

    <div id="mainContent" class="hidden max-w-4xl mx-auto space-y-10">
        
        <header class="flex justify-between items-center bg-police text-white p-5 rounded-2xl shadow-xl">
            <div class="font-black italic uppercase">Eenheid: <span id="displayKlas" class="text-yellow-400"></span></div>
            <button onclick="resetAlles()" class="bg-red-600 px-4 py-2 rounded-lg font-black text-[10px] uppercase">Reset Alle Velden</button>
        </header>

        <section class="space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-police border-t-4 border-police">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-black uppercase text-sm text-police italic">Deel 2a: Redenen van Wetenschap</h2>
                    <button onclick="clear_c1()" class="text-[10px] font-bold text-red-600 uppercase border border-red-200 px-2 py-1 rounded">Gum Bord</button>
                </div>
                <canvas id="c1" class="w-full bg-slate-50 border-2 rounded-xl mb-4 touch-none"></canvas>
                <textarea id="t1" class="w-full border-2 p-4 rounded-xl text-sm h-20" placeholder="Toelichting bij redenen van wetenschap..."></textarea>
                <button onclick="sendData('Redenen Wetenschap', 't1')" class="w-full bg-police text-white py-3 mt-2 rounded-xl font-black uppercase text-xs">Inleveren</button>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-police border-t-4 border-police">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-black uppercase text-sm text-police italic">Deel 2b: ovt let op de ik-vorm</h2>
                    <button onclick="clear_c2()" class="text-[10px] font-bold text-red-600 uppercase border border-red-200 px-2 py-1 rounded">Gum Bord</button>
                </div>
                <canvas id="c2" class="w-full bg-slate-50 border-2 rounded-xl mb-4 touch-none"></canvas>
                <textarea id="t2" class="w-full border-2 p-4 rounded-xl text-sm h-20" placeholder="Toelichting bij schets..."></textarea>
                <button onclick="sendData('Situatieschets', 't2')" class="w-full bg-police text-white py-3 mt-2 rounded-xl font-black uppercase text-xs">Inleveren</button>
            </div>
        </section>

        <section class="bg-white p-6 rounded-2xl shadow-police border-t-4 border-police">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 class="font-black uppercase text-sm text-police italic underline">Deel 3: Actieve Verleden Tijd</h2>
                <div class="bg-green-600 text-white px-4 py-1 rounded-full font-black text-xs">Score: <span id="liveScore">0</span>/15</div>
            </div>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-2 text-[10px] font-bold bg-slate-50 p-4 rounded-xl h-[350px] overflow-y-auto">
                    <script>
                        const zinnen = [
                            "De motorrijder is door mij in stabiele zijligging gelegd.", "De kruising is door mij direct afgezet.", "De ambulance is door mij via het OC opgeroepen.",
                            "Het slachtoffer is door mij voorzichtig aangesproken.", "Het verkeer is door mij op afstand gehouden.", "De motorfiets is door mij op de stoep geplaatst.",
                            "Het letsel is door mij nauwkeurig bekeken.", "De helm is door mij niet verwijderd.", "De getuigen zijn door mij apart gezet.",
                            "De rugklachten zijn door mij genoteerd.", "Het bewustzijn is door mij gecontroleerd.", "De vloeistoffen op de weg zijn door mij gemarkeerd.",
                            "De persoonsgegevens zijn door mij opgevraagd.", "De route is door mij vrijgemaakt.", "Het PV is door mij direct opgesteld."
                        ];
                        zinnen.forEach((z, i) => document.write(`
                            <div class="flex items-center gap-3 bg-white p-2 rounded border border-slate-200">
                                <span id="check-${i+1}" class="w-3 h-3 rounded-full bg-slate-300 shrink-0"></span>
                                <span>${i+1}. ${z}</span>
                            </div>`));
                    </script>
                </div>
                <textarea id="zinInput" oninput="checkZinnen()" class="w-full border-2 p-4 rounded-xl text-sm h-[350px] outline-none focus:border-police" placeholder="Schrijf hier de actieve ik-zinnen..."></textarea>
            </div>
        </section>

        <section class="bg-red-700 text-white p-6 rounded-2xl shadow-xl border-l-8 border-yellow-500">
            <h2 class="font-black uppercase text-xs mb-3 text-yellow-400 underline">Deel 4: Melding OC</h2>
            <p class="font-mono text-sm italic leading-relaxed text-white">
                “Wilt u gaan naar kruising Vincent van Goghweg met de Westzijde in Zaandam. Hier is een motorrijder gevallen. 
                Het slachtoffer is aanspreekbaar en heeft mogelijk letsel. De ambulance is onderweg en u heeft toestemming.”
            </p>
        </section>

        <section class="bg-yellow-50 border-4 border-yellow-400 p-6 rounded-2xl shadow-lg">
            <h2 class="font-black uppercase text-sm mb-4 text-yellow-900 italic text-center underline">Deel 5: Stel uw DAA op</h2>
            <textarea id="daaInput" class="w-full border-2 border-yellow-200 p-5 rounded-xl text-sm h-40 shadow-inner" placeholder="Doel - Aanpak - Analyse..."></textarea>
            <button onclick="sendData('DAA', 'daaInput')" class="w-full bg-yellow-600 text-white py-4 mt-4 rounded-xl font-black uppercase text-xs shadow-md">Verstuur DAA naar Livefeed</button>
        </section>

        <section class="bg-white p-6 rounded-2xl shadow-police border-t-4 border-police">
            <h2 class="font-black uppercase text-xs mb-4 text-police underline">Deel 6: Ter Plaatse</h2>
            <p class="text-sm italic leading-relaxed mb-6 text-slate-700">
                Op de kruising zie je een motorfiets liggen en een stukje verderop een persoon in een motorpak en een helm op. 
                Het slachtoffer geeft aan dat hij onderuit is gegleden in de bocht terwijl hij ongeveer 50 km/u reed.
            </p>
            <div class="grid grid-cols-3 gap-4">
                <div class="text-center"><img src="bord50.png" alt="Bord 50" class="rounded border shadow-sm mx-auto mb-1"><span class="text-[8px] font-bold uppercase">bord50.png</span></div>
                <div class="text-center"><img src="kruispuntgooglemaps.png" alt="Maps" class="rounded border shadow-sm mx-auto mb-1"><span class="text-[8px] font-bold uppercase">maps.png</span></div>
                <div class="text-center"><img src="overzichtkruispunt.png" alt="Overzicht" class="rounded border shadow-sm mx-auto mb-1"><span class="text-[8px] font-bold uppercase">kruispunt.png</span></div>
            </div>
        </section>

        <section class="bg-white p-6 rounded-2xl shadow-police border-t-4 border-police">
            <h2 class="font-black uppercase text-sm mb-4 text-police italic underline">Deel 7: PV Bevindingen</h2>
            <textarea id="pvInput" class="w-full border-2 p-5 rounded-xl text-sm h-60" placeholder="Stel hier je PV van bevindingen op..."></textarea>
            <button onclick="sendData('PV Bevindingen', 'pvInput')" class="w-full bg-police text-white py-4 mt-4 rounded-xl font-black uppercase text-xs shadow-md italic">Verstuur PV naar Livefeed</button>
        </section>

        <section class="bg-slate-100 p-6 rounded-2xl border-2 border-slate-300 shadow-inner">
            <h2 class="font-black uppercase text-sm mb-6 text-slate-700 italic border-b pb-2 text-center">Deel 8: Feedback Checklist</h2>
            <p class="text-[10px] text-slate-500 mb-4 uppercase text-center font-bold italic">Vink aan wat je hebt behandeld in je DAA of PV</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="feedbackChecklist">
                <label class="flex items-center gap-3 bg-white p-3 rounded-lg text-[11px] font-bold border cursor-pointer hover:bg-blue-50 transition-colors"><input type="checkbox" value="Dienstvoertuig Positie"> Hoe positioneer je je dienstvoertuig?</label>
                <label class="flex items-center gap-3 bg-white p-3 rounded-lg text-[11px] font-bold border cursor-pointer hover:bg-blue-50 transition-colors"><input type="checkbox" value="Veiligheid Ter Plaatse"> Welke veiligheidsmaatregelen neem je?</label>
                <label class="flex items-center gap-3 bg-white p-3 rounded-lg text-[11px] font-bold border cursor-pointer hover:bg-blue-50 transition-colors"><input type="checkbox" value="METHANE"> METHANE-methode terugmelding?</label>
                <label class="flex items-center gap-3 bg-white p-3 rounded-lg text-[11px] font-bold border cursor-pointer hover:bg-blue-50 transition-colors"><input type="checkbox" value="Strafbaar Feit"> Welk strafbaar feit is hier sprake?</label>
                <label class="flex items-center gap-3 bg-white p-3 rounded-lg text-[11px] font-bold border cursor-pointer hover:bg-blue-50 transition-colors"><input type="checkbox" value="Partners"> Welke partners inschakelen?</label>
                <label class="flex items-center gap-3 bg-white p-3 rounded-lg text-[11px] font-bold border cursor-pointer hover:bg-blue-50 transition-colors"><input type="checkbox" value="Opsporing"> Welke opsporingsactiviteiten?</label>
            </div>
        </section>

        <section class="mt-10">
            <div class="flex items-center gap-4 mb-6">
                <div class="h-px bg-slate-300 flex-1"></div>
                <h2 class="font-black uppercase text-[10px] text-slate-400 tracking-widest italic">Live Feed Eenheidspagina</h2>
                <div class="h-px bg-slate-300 flex-1"></div>
            </div>
            <div id="liveFeed" class="space-y-4"></div>
        </section>

    </div>

</body>
</html>
