<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BTV Dashboard - Zaandam 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp, collection, addDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBRq1HFmhrpW_EMMZwpURrbTArz-L5iWT4",
            authDomain: "pvaangifteinleveren-77dbe.firebaseapp.com",
            projectId: "pvaangifteinleveren-77dbe",
            storageBucket: "pvaangifteinleveren-77dbe.firebasestorage.app",
            messagingSenderId: "20239054410",
            appId: "1:20239054410:web:264b3c759312248d9f18b3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const LES_ID = "btv_zaandam_2026_final";

        window.startLes = () => {
            const naam = document.getElementById('uNaam').value.trim();
            const klas = document.getElementById('uKlas').value;
            if(!naam || !klas) return alert("Vul voornaam en eenheid in.");
            document.getElementById('loginOverlay').style.display='none';
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('displayKlas').innerText = klas;
            initLive(klas, naam);
        };

        async function initLive(klas, naam) {
            setupWhiteboard('c1', LES_ID + '_bord1_' + klas, db);
            setupWhiteboard('c2', LES_ID + '_bord2_' + klas, db);
            
            const q = query(collection(db, "btv_inzendingen"), where("klas", "==", klas), orderBy("ts", "desc"));
            onSnapshot(q, (sn) => {
                const feed = document.getElementById('liveFeed');
                feed.innerHTML = "";
                sn.forEach(d => {
                    const data = d.data();
                    feed.innerHTML += `
                        <div class="bg-white p-4 mb-4 rounded-xl border-l-8 border-blue-900 shadow-md">
                            <div class="flex justify-between font-black text-[10px] text-blue-900 uppercase mb-2">
                                <span>${data.naam}</span><span>${data.type}</span>
                            </div>
                            <p class="text-slate-800 italic mb-2">${data.txt}</p>
                            ${data.feedback ? `<div class="mt-2 pt-2 border-t border-slate-100 text-[10px] text-blue-700 font-bold uppercase italic">Checks: ${data.feedback}</div>` : ''}
                        </div>`;
                });
            });
        }

        window.sendData = async (type, elementId) => {
            const txt = document.getElementById(elementId).value;
            const naam = document.getElementById('uNaam').value;
            const klas = document.getElementById('uKlas').value;
            if(!txt) return alert("Veld is leeg.");
            
            // Verzamel feedback checks
            const gekozen = Array.from(document.querySelectorAll('#feedbackChecklist input:checked')).map(c => c.value);
            
            await addDoc(collection(db, "btv_inzendingen"), { 
                naam, klas, type, txt, ts: serverTimestamp(),
                feedback: gekozen.join(", ")
            });
            alert(type + " is succesvol verzonden naar de livefeed!");
        };
    </script>

    <script>
        // NAKIJK LOGICA
        const criteria = [
            ["ik legde", "zijligging"], ["ik zette", "kruising", "af"], ["ik riep", "ambulance"],
            ["ik sprak", "slachtoffer", "aan"], ["ik hield", "verkeer", "afstand"], ["ik plaatste", "motorfiets"],
            ["ik bekeek", "letsel"], ["ik verwijderde", "helm", "niet"], ["ik zette", "getuigen", "apart"],
            ["ik noteerde", "rugklachten"], ["ik controleerde", "bewustzijn"], ["ik markeerde", "vloeistoffen"],
            ["ik vroeg", "gegevens", "op"], ["ik maakte", "route", "vrij"], ["ik stelde", "pv", "op"]
        ];

        function checkZinnen() {
            const tekst = document.getElementById('zinInput').value.toLowerCase();
            let score = 0;
            for(let i=0; i < criteria.length; i++) {
                const indicator = document.getElementById(`check-${i+1}`);
                const isCorrect = criteria[i].every(w => tekst.includes(w));
                if(indicator) indicator.className = isCorrect ? "w-3 h-3 rounded-full bg-green-500 shadow-[0_0_8px_green]" : "w-3 h-3 rounded-full bg-slate-300";
                if(isCorrect) score++;
            }
            document.getElementById('liveScore').innerText = score;
        }

        function setupWhiteboard(id, docName, db) {
            const c = document.getElementById(id); const ctx = c.getContext('2d');
            c.width = c.offsetWidth; c.height = 200;
            let draw = false; ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#002d5e';
            
            const getP = (e) => { 
                const r = c.getBoundingClientRect(); 
                return { x: (e.touches?.[0].clientX || e.clientX) - r.left, y: (e.touches?.[0].clientY || e.clientY) - r.top }; 
            };
            
            c.onmousedown = (e) => { draw=true; ctx.beginPath(); const p=getP(e); ctx.moveTo(p.x, p.y); };
            c.onmousemove = (e) => { if(!draw) return; const p=getP(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
            
            // GUM FUNCTIE HERSTELD
            window['clear_'+id] = () => { 
                ctx.clearRect(0, 0, c.width, c.height); 
                ctx.beginPath(); // Reset pad voor nieuwe tekening
            };

            const stop = async () => { if(!draw) return; draw=false; };
            window.addEventListener('mouseup', stop);
            c.addEventListener('touchstart', (e) => { draw=true; ctx.beginPath(); const p=getP(e); ctx.moveTo(p.x, p.y); e.preventDefault(); }, {passive: false});
            c.addEventListener('touchmove', (e) => { if(!draw) return; const p=getP(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); }, {passive: false});
        }
    </script>

    <style>
        .bg-police { background-color: #002d5e; }
        label { cursor: pointer; }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-900 pb-20 p-4">

    <div id="loginOverlay" class="fixed inset-0 bg-police z-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded shadow-2xl w-full max-w-lg border-t-8 border-yellow-500">
            <h1 class="font-black text-2xl mb-4 text-police italic uppercase">Instructie</h1>
            <p class="text-sm text-slate-600 mb-6">Log in met je voornaam en kies de eenheid (Delta, Echo, Foxtrot, Kilo, Lima, Mike). Werk de onderdelen van boven naar beneden af.</p>
            <input type="text" id="uNaam" placeholder="Voornaam" class="w-full border-2 p-4 rounded-lg mb-4 font-bold text-center outline-none focus:border-police">
            <select id="uKlas" class="w-full border-2 p-4 rounded-lg mb-8 font-bold text-center outline-none">
                <option value="">-- Kies Eenheid --</option>
                <option>Delta</option><option>Echo</option><option>Foxtrot</option><option>Kilo</option><option>Lima</
