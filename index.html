<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PV Training Master - 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp, collection, addDoc, query, where, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBRq1HFmhrpW_EMMZwpURrbTArz-L5iWT4",
            authDomain: "pvaangifteinleveren-77dbe.firebaseapp.com",
            projectId: "pvaangifteinleveren-77dbe",
            storageBucket: "pvaangifteinleveren-77dbe.firebasestorage.app",
            messagingSenderId: "20239054410",
            appId: "1:20239054410:web:264b3c759312248d9f18b3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- CANVAS COLLABORATIE LOGICA ---
        function setupWhiteboard(canvasId, docName) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            let drawing = false;

            // Formaat fix voor schermen
            canvas.width = canvas.offsetWidth;
            canvas.height = 250;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#002d5e';

            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };

            const start = (e) => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); e.preventDefault(); };
            const move = (e) => { if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); };
            
            const stop = async () => { 
                if(!drawing) return; 
                drawing = false; 
                // Compressie naar 0.5 om Firebase licht te houden
                const dataUrl = canvas.toDataURL('image/webp', 0.5); 
                await setDoc(doc(db, "whiteboards", docName), { image: dataUrl, timestamp: serverTimestamp() });
            };

            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', move);
            window.addEventListener('mouseup', stop);
            canvas.addEventListener('touchstart', start, {passive: false});
            canvas.addEventListener('touchmove', move, {passive: false});
            canvas.addEventListener('touchend', stop);

            // Real-time update van andere gebruikers
            onSnapshot(doc(db, "whiteboards", docName), (snapshot) => {
                if (snapshot.exists() && !drawing) {
                    const img = new Image();
                    img.onload = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0); };
                    img.src = snapshot.data().image;
                }
            });
        }

        // Reset functie: Maakt bord leeg voor iedereen
        window.resetBoard = async (docName, canvasId) => {
            if(!confirm("Weet je zeker dat je dit bord wilt wissen voor iedereen?")) return;
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL('image/webp', 0.1);
            await setDoc(doc(db, "whiteboards", docName), { image: dataUrl, timestamp: serverTimestamp() });
        };

        window.onload = () => {
            setupWhiteboard('canvasRedenen', 'redenen');
            setupWhiteboard('canvasFilmisch', 'filmisch');
        };

        // --- OVERIGE FUNCTIES (PV INLEVEREN) ---
        window.submitCasus = async () => {
            const naam = document.getElementById('naam').value;
            const klas = document.getElementById('klas').value;
            const pv = document.getElementById('pvText').value;
            if(!naam || !klas || !pv) return alert("Vul alles in!");
            await addDoc(collection(db, "casus_inzendingen"), { student: naam, klas, pv, timestamp: serverTimestamp() });
            alert("Ingeleverd!");
        };

        window.laadKlas = (gekozenKlas) => {
            document.getElementById('currentKlas').innerText = gekozenKlas;
            const q = query(collection(db, "casus_inzendingen"), where("klas", "==", gekozenKlas), orderBy("timestamp", "desc"));
            onSnapshot(q, (s) => {
                const lijst = document.getElementById('feedbackLijst');
                let h = "";
                s.forEach(docSnap => {
                    const d = docSnap.data();
                    h += `<div class="bg-white border-2 border-blue-900 p-4 mb-4 rounded shadow">
                        <p class="text-[10px] font-black text-blue-900 uppercase">Student: ${d.student}</p>
                        <div class="mt-2 text-sm font-serif border-l-4 border-blue-900 pl-3">${d.pv}</div>
                    </div>`;
                });
                lijst.innerHTML = h || "<p class='text-gray-400'>Nog geen inzendingen.</p>";
            });
        };
    </script>

    <style>
        .police-blue { background-color: #002d5e; }
        canvas { touch-action: none; cursor: crosshair; }
    </style>
</head>
<body class="bg-gray-100 p-2 md:p-8">
    <div class="max-w-4xl mx-auto">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
            <section class="bg-white border-2 border-blue-900 p-4 shadow-md relative">
                <h2 class="text-[10px] font-black text-blue-900 uppercase mb-2 text-left">Waarnemingen (Tekenen)</h2>
                <canvas id="canvasRedenen" class="w-full bg-yellow-50 border border-yellow-200 rounded touch-none"></canvas>
                <button onclick="resetBoard('redenen', 'canvasRedenen')" class="absolute top-2 right-2 bg-red-500 text-white text-[8px] px-2 py-1 rounded font-bold uppercase hover:bg-red-700">Reset Bord</button>
            </section>

            <section class="bg-white border-2 border-blue-900 p-4 shadow-md relative">
                <h2 class="text-[10px] font-black text-blue-900 uppercase mb-2 text-left">Filmische Zinnen (Tekenen)</h2>
                <canvas id="canvasFilmisch" class="w-full bg-blue-50 border border-blue-100 rounded touch-none"></canvas>
                <button onclick="resetBoard('filmisch', 'canvasFilmisch')" class="absolute top-2 right-2 bg-red-500 text-white text-[8px] px-2 py-1 rounded font-bold uppercase hover:bg-red-700">Reset Bord</button>
            </section>
        </div>

        <section class="bg-white p-6 border shadow-md mb-8">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <input type="text" id="naam" placeholder="Naam" class="border p-3 text-sm bg-gray-50 rounded">
                <select id="klas" class="border p-3 text-sm font-bold rounded">
                    <option value="">Kies klas...</option><option>Delta</option><option>Echo</option><option>Foxtrot</option><option>Mike</option><option>Lima</option>
                </select>
            </div>
            <textarea id="pvText" placeholder="Jouw PV in de IK-vorm..." class="w-full border p-4 text-sm h-48 mb-4 rounded bg-gray-50 outline-none"></textarea>
            <button onclick="submitCasus()" class="w-full police-blue text-white font-black py-4 uppercase text-xs rounded">Definitief Inleveren</button>
        </section>

        <div class="flex flex-wrap justify-center gap-2 mb-4">
            <button onclick="laadKlas('Delta')" class="police-blue text-white px-3 py-2 rounded text-[10px] font-bold">DELTA</button>
            <button onclick="laadKlas('Echo')" class="police-blue text-white px-3 py-2 rounded text-[10px] font-bold">ECHO</button>
            <button onclick="laadKlas('Foxtrot')" class="police-blue text-white px-3 py-2 rounded text-[10px] font-bold">FOXTROT</button>
        </div>
        <h3 class="text-center font-black text-blue-900 uppercase text-[10px] mb-4">Klas: <span id="currentKlas">-</span></h3>
        <div id="feedbackLijst" class="pb-20"></div>
    </div>
</body>
</html>
